---
layout: post
title:  "无缓冲和有缓冲读写文件的性能对比"
date:   2021-12-05
description: '无缓冲和有缓冲读写文件的性能对比'
category: notes

---

先准备一个大点的文件 `1.pdf`，我这边是 80 M左右。


## syscpy.go

不带缓冲读写文件：

```go
var (
	BUF_SIZE = 3 
)

func main() {
	file1, _ := os.OpenFile("1.pdf", os.O_RDONLY, 0)
	defer file1.Close()
	file2, _ := os.OpenFile("copy.pdf", os.O_CREATE|os.O_TRUNC|os.O_RDWR, 0644)
	defer file2.Close()

	buf := make([]byte, BUF_SIZE)
	i := 0
	for {
		len, err := file1.Read(buf)
		if err != nil && err != io.EOF {
			break
		}
		if len == 0 {
			break
		}
		file2.Write(buf[:len])
		i += len
	}
	os.Exit(0)
}
```

## stdcpy.go

带缓冲读写文件

```go

var (
	BUF_SIZE = 3 
)

func main() {
	file1, _ := os.OpenFile("1.pdf", os.O_RDONLY, 0)
	defer file1.Close()
	file2, _ := os.OpenFile("copy.pdf", os.O_CREATE|os.O_TRUNC|os.O_RDWR, 0644)
	defer file2.Close()

	r := bufio.NewReader(file1)
	w := bufio.NewWriter(file2)

	buf := make([]byte, BUF_SIZE)
	i := 0
	for {
		len, err := r.Read(buf)
		if err != nil && err != io.EOF {
			break
		}
		if len == 0 {
			break
		}
		w.Write(buf[:len])
		i += len
	}
	os.Exit(0)
}
```

## 测试对比：

```bash
time go run syscpy.go                                                
# go run syscpy.go  25.83s user 113.55s system 100% cpu 2:18.55 total

time go run stdcpy.go                                                                         
# go run stdcpy.go  0.55s user 0.57s system 60% cpu 1.830 total
```

一个用时 25.83s，另一个仅仅  0.57s，看起来差不多 50 倍的时间差距，而且不带缓冲时 CPU 使用率是 100%，差别还是蛮大的